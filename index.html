<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Opendata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 400px; margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 40px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>

  <h1>Arbres à Bordeaux (OpenData)</h1>
  <p id="total"></p>

  <div id="map"></div>

  <table id="treeTable">
    <thead>
      <tr>
        <th>Nom Français</th>
        <th>Station</th>
        <th>Circonférence (cm)</th>
        <th>Hauteur (m)</th>
        <th>Statut</th>
        <th>Diamètre (cm)</th>
        <th>Essence</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiamVqZTMzMDAwIiwiYSI6ImNtZTJ2c3RnaDAwczEyanF6bW9wODI0cTgifQ.AYOAKWDyDLP_fbKIz-QdwQ';

    const url = 'https://bmproxy.jeromevallies.workers.dev/';

    fetch(url, { mode: 'cors' })
      .then(resp => {
        if (!resp.ok) throw new Error('Erreur réseau');
        return resp.json();
      })
      .then(data => {
        document.getElementById('total').textContent = `Nombre total d'arbres : ${data.total_count}`;

        const tbody = document.querySelector('#treeTable tbody');
        data.results.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.nom_francais || ''}</td>
            <td>${item.station || ''}</td>
            <td>${item.circonference || ''}</td>
            <td>${item.hauteur || ''}</td>
            <td>${item.statut || ''}</td>
            <td>${item.diametre || ''}</td>
            <td>${item.essence || ''}</td>
          `;
          tbody.appendChild(tr);
        });

        // Initialisation de la carte centrée sur Bordeaux
        const map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [-0.57, 44.85], // Bordeaux approx
          zoom: 13
        });

        // Ajout des markers
        data.results.forEach(item => {
          if (item.geo_point_2d && item.geo_point_2d.lon && item.geo_point_2d.lat) {
            const marker = new mapboxgl.Marker()
              .setLngLat([item.geo_point_2d.lon, item.geo_point_2d.lat])
              .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML(`
                  <strong>${item.nom_francais || 'Arbre'}</strong><br/>
                  Station: ${item.station || 'N/A'}<br/>
                  Circonférence: ${item.circonference || 'N/A'} cm<br/>
                  Hauteur: ${item.hauteur || 'N/A'} m<br/>
                  Essence: ${item.essence || 'N/A'}
                `))
              .addTo(map);
          }
        });

      })
      .catch(error => {
        document.body.innerHTML = `<p>Erreur lors du chargement des données : ${error.message}</p>`;
        console.error(error);
      });
  </script>

</body>
</html>
